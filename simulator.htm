<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IoT Simulator (Thi·∫øt b·ªã ·∫£o)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        .status-box { 
            background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto;
        }
        h2 { text-align: center; color: #2c3e50; }
        .log { font-family: monospace; color: #d63031; margin-top: 10px; }
        button { 
            display: block; width: 100%; padding: 10px; margin-top: 20px;
            background: #0984e3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
        }
        button:hover { background: #74b9ff; }
        button.stop { background: #d63031; }
    </style>
</head>
<body>

    <div class="status-box">
        <h2>üå°Ô∏è Gi·∫£ l·∫≠p d·ªØ li·ªáu IoT</h2>
        <p>Tr·∫°ng th√°i: <b id="status" style="color: red;">ƒêang d·ª´ng</b></p>
        <div id="values">
            <p>Nhi·ªát ƒë·ªô: --</p>
            <p>ƒê·ªô ·∫©m KK: --</p>
            <p>ƒê·ªô ·∫©m ƒë·∫•t: --</p>
            <p>√Ånh s√°ng: --</p>
        </div>
        <button id="toggleBtn" onclick="toggleSimulation()">B·∫Øt ƒë·∫ßu gi·∫£ l·∫≠p</button>
        <p class="log" id="logMsg"></p>
    </div>

    <script type="module">
        // 1. C·∫•u h√¨nh Firebase (Y h·ªát project c·ªßa b·∫°n)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
        
    const firebaseConfig = {
        apiKey: "AIzaSyC_5zwHVBSGlafgtSerW6DWQ5_MoocACRo",
        authDomain: "iot-green-house-ebeaf.firebaseapp.com",
        databaseURL: "https://iot-green-house-ebeaf-default-rtdb.firebaseio.com",
        projectId: "iot-green-house-ebeaf",
        storageBucket: "iot-green-house-ebeaf.firebasestorage.app",
        messagingSenderId: "472750644936",
        appId: "1:472750644936:web:c402395617eb24e3f7cffd",
        measurementId: "G-VWSXQ37WJG"
    };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Bi·∫øn ki·ªÉm so√°t v√≤ng l·∫∑p
        let intervalId = null;
        let isRunning = false;

        // H√†m sinh s·ªë ng·∫´u nhi√™n trong kho·∫£ng (min, max)
        function getRandom(min, max, isFloat = false) {
            const num = Math.random() * (max - min) + min;
            return isFloat ? num.toFixed(1) : Math.floor(num);
        }

        // H√†m g·ª≠i d·ªØ li·ªáu l√™n Firebase
        window.startSim = function() {
            const statusText = document.getElementById('status');
            const logMsg = document.getElementById('logMsg');
            const valuesDiv = document.getElementById('values');

            statusText.innerText = "ƒêang ch·∫°y d·ªØ li·ªáu th·ª±c...";
            statusText.style.color = "green";

            // CH·∫†Y V√íNG L·∫∂P G·ª¨I DATA SAU M·ªñI 3 GI√ÇY
            intervalId = setInterval(() => {
                // 1. T·∫°o d·ªØ li·ªáu gi·∫£ ng·∫´u nhi√™n
                const fakeTemp = getRandom(20, 40, true);   // Nhi·ªát ƒë·ªô: 28 - 35 ƒë·ªô
                const fakeHum = getRandom(20, 90);          // ƒê·ªô ·∫©m: 60 - 90 %
                const fakeSoil = getRandom(40, 90);         // ƒê·∫•t: 40 - 80 %
                const fakeLight = getRandom(100, 1000);     // √Ånh s√°ng: 100 - 1000 lux
                
                const timestamp = Date.now(); // L·∫•y th·ªùi gian hi·ªán t·∫°i

                // 2. G·ª≠i l√™n Firebase (D√πng h√†m set ƒë·ªÉ ghi ƒë√® gi√° tr·ªã c≈©)
                // L∆∞u √Ω: ƒê∆∞·ªùng d·∫´n ph·∫£i kh·ªõp v·ªõi web ch√≠nh: Green_house/temp, hum, soil_hum, light
                set(ref(db, 'Green_house/temp'), parseFloat(fakeTemp));
                set(ref(db, 'Green_house/hum'), parseInt(fakeHum));
                set(ref(db, 'Green_house/soil_hum'), parseInt(fakeSoil));
                set(ref(db, 'Green_house/light'), parseInt(fakeLight));

                // --- VI·ªÜC 2: L∆ØU V√ÄO L·ªäCH S·ª¨ (D√πng push - M·ªöI) ---
                // Firebase s·∫Ω t·ª± sinh ra m·ªôt ID ng·∫´u nhi√™n cho m·ªói l·∫ßn push
                push(ref(db, 'Green_house_logs/temp'), {
                    value: parseFloat(fakeTemp),
                    time: timestamp
                });
                push(ref(db, 'Green_house_logs/hum'), {
                    value: parseFloat(fakeHum),
                    time: timestamp
                });
                push(ref(db, 'Green_house_logs/soil'), {
                    value: parseFloat(fakeSoil),
                    time: timestamp
                });
                push(ref(db, 'Green_house_logs/light'), {
                    value: parseFloat(fakeLight),
                    time: timestamp
                });
                // 3. Hi·ªÉn th·ªã log ch∆°i cho vui
                valuesDiv.innerHTML = `
                    <p>Nhi·ªát ƒë·ªô: ${fakeTemp}¬∞C</p>
                    <p>ƒê·ªô ·∫©m KK: ${fakeHum}%</p>
                    <p>ƒê·ªô ·∫©m ƒë·∫•t: ${fakeSoil}%</p>
                    <p>√Ånh s√°ng: ${fakeLight} lux</p>
                `;
                logMsg.innerText = `ƒê√£ g·ª≠i l√∫c ${new Date().toLocaleTimeString()}`;

            }, 3000); // 3000ms = 3 gi√¢y g·ª≠i 1 l·∫ßn
        }

        window.stopSim = function() {
            clearInterval(intervalId);
            const statusText = document.getElementById('status');
            statusText.innerText = "ƒê√£ d·ª´ng";
            statusText.style.color = "red";
        }

        // G·∫Øn h√†m v√†o window ƒë·ªÉ n√∫t b·∫•m HTML g·ªçi ƒë∆∞·ª£c (do type="module")
        window.toggleSimulation = function() {
            const btn = document.getElementById('toggleBtn');
            if (!isRunning) {
                window.startSim();
                btn.innerText = "D·ª´ng gi·∫£ l·∫≠p";
                btn.classList.add('stop');
                isRunning = true;
            } else {
                window.stopSim();
                btn.innerText = "B·∫Øt ƒë·∫ßu gi·∫£ l·∫≠p";
                btn.classList.remove('stop');
                isRunning = false;
            }
        }
    </script>
</body>
</html>